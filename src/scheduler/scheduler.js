// src/scheduler/scheduler.js
require('dotenv').config(); // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ dotenv ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏ô .env

// üö® ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
let lastSentMinute = -1;

// ----------------------------------------------------------------
// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á DM
// ----------------------------------------------------------------
function sendScheduledDM(client, targetUserId, message) {
    client.users.fetch(targetUserId)
        .then(user => {
            user.send(message)
                .then(() => console.log(`‚úÖ [Scheduler] ‡∏™‡πà‡∏á DM ‡∏ñ‡∏∂‡∏á ${user.tag} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`))
                .catch(error => console.error(`‚ùå [Scheduler] ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á DM ‡∏ñ‡∏∂‡∏á ${user.tag} ‡πÑ‡∏î‡πâ:`, error));
        })
        .catch(error => console.error(`‚ùå [Scheduler] ‡πÑ‡∏°‡πà‡∏û‡∏ö User ID ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${targetUserId}):`, error));
}


// ----------------------------------------------------------------
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Scheduler
// ----------------------------------------------------------------
module.exports.startScheduler = (client) => {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ env 
    const TARGET_USER_IDS = [
        process.env.TARGET_USER_ID1,
        process.env.TARGET_USER_ID2,
        process.env.TARGET_USER_ID3,
        process.env.TARGET_USER_ID4,
        process.env.TARGET_USER_ID5,
    ]
    // ‚≠êÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î ID: ‡∏•‡∏ö quotes ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    .map(id => {
        if (!id) return null;
        return id.toString().replaceAll("'", "").replaceAll('"', '').trim();
    })
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    .filter(id => id && id.length > 0);

    const TIME_TO_CHECK = '21:08'; // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ (HH:MM)
    const INTERVAL_MS = 30000;      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    
    if (TARGET_USER_IDS.length === 0) {
        console.warn('‚ö†Ô∏è [Scheduler] ‡πÑ‡∏°‡πà‡∏û‡∏ö TARGET_USER_ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå .env ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° Scheduler');
        return;
    }

    console.log(`‚è±Ô∏è [Scheduler] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å‡πÜ ${INTERVAL_MS / 1000} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (${TARGET_USER_IDS.length} ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)...`);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Scheduler
    setInterval(() => {
        const now = new Date();
        
        // ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô Time Zone ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢
        const currentTime = now.toLocaleTimeString('th-TH', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit',
            timeZone: 'Asia/Bangkok' // ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ (UTC+7)
        });
        
        const currentMinute = now.getMinutes(); 

        if (currentTime === TIME_TO_CHECK) {
            
            // ‚≠êÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ñ‡πâ‡∏≤‡∏ô‡∏≤‡∏ó‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ô‡∏≤‡∏ó‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ (lastSentMinute)
            if (currentMinute !== lastSentMinute) {
                
                const message = `üö® ‡πÄ‡∏ó‡∏™‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏∞‡∏î‡∏∂‡∏Å! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ${TIME_TO_CHECK} ‡∏ô. ‡πÅ‡∏•‡πâ‡∏ß`;
                
                // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á DM ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô
                TARGET_USER_IDS.forEach(userId => {
                    sendScheduledDM(client, userId, message);
                });
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
                lastSentMinute = currentMinute; 
                console.log(`‚úâÔ∏è [Scheduler] ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà ${lastSentMinute}`);

            }
            // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô 04:27) ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏µ‡πâ
            
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πà‡∏ô 04:28) ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            lastSentMinute = -1; 
        }
        
    }, INTERVAL_MS);
};